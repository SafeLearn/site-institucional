<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/dashboard.css" />
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="shortcut icon" href="./imagens/logoSafePrint.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <title>SafeLearn -- Dashboard</title>
</head>

<body onload="visaoGeral(), statusComponentes()">
  <div class="container">
    <nav>
      <ul>
        <li>
          <a href="#" class="logo">
            <img src="./imagens/logoSafePrint.png" alt="" />
            <span class="nav-item">DashBoard</span>
          </a>
        </li>

        <li>
          <a href="./dashboard.html" id="active">
            <i class="fas fa-home"></i>
            <span class="nav-item">Home</span>
          </a>
        </li>

        <li class="criarUsuarioNavegador">
          <a href="./criaruser.html">
            <i class="fas fa-user"></i>
            <span class="nav-item">Usuários</span>
          </a>
        </li>

        <li>
          <a href="./nivelacesso.html">
            <i class="fa-solid fa-universal-access"></i>
            <span class="nav-item">Nivel de Acesso</span>
          </a>
        </li>

        <li>
          <a href="./monitorar.html">
            <i class="fas fa-chart-bar"></i>
            <span class="nav-item">Monitoramento</span>
          </a>
        </li>

        <li>
          <a href="./suporte.html">
            <i class="fas fa-question-circle"></i>
            <span class="nav-item">Suporte</span>
          </a>
        </li>
        <li>
          <a href="./home.html" class="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span class="nav-item">Sair</span>
          </a>
        </li>
      </ul>
    </nav>

    <section class="main">
      <div class="main-top">
        <h1>Home</h1>
        <i class="fas fa-user-cog"></i>
      </div>

      <div class="titulo">
        <h2 id="saudacoes"></h2>
        <p>Esses são os dados mais recentes de suas máquinas</p>
      </div>

      <div class="conteudo">
        <div class="indicadores">
          <div class="card">
            <div class="titulo">
              <p>Visão Geral</p>
              <div class="indicadores-cores">
                <div class="indicador-verde"></div>
                <p>Estável</p>
                <div class="indicador-amarelo"></div>
                <p>Alerta</p>

                <div class="indicador-vermelho"></div>
                <p>Risco</p>
              </div>
            </div>
            <div class="lista-overview">
              <span class="item-lista">
                <p>Máquinas Ligadas:</p>
                <p id="maquinas_ligadas">-</p>
                <div id="barra-status" class="barra-status"></div>
                <i class="fa-regular fa-eye" onclick="openModal('modal1')" data-modal-id="modal1"></i>
              </span>
              <span class="item-lista">
                <p>Máquinas em risco:</p>
                <p id="maquinas_risco">-</p>
                <div id="barra_status_risco" class="barra-status"></div>
                <i class="fa-regular fa-eye" onclick="openModal('modal2')" data-modal-id="modal2"></i>
              </span>
              <span class="item-lista">
                <p>Máquinas com pouca bateria:</p>
                <p id="maquinas_pouca_bateria">-</p>
                <div id="barra_status_bateria" class="barra-status"></div>
                <i class="fa-regular fa-eye" onclick="openModal('modal3')" data-modal-id="modal3"></i>
              </span>
            </div>
          </div>
          <div class="card">
            <p>Status dos componentes por computador(%)</p>
            <div class="titulo">
              <span>Máquina</span>
              <span>CPU</span>
              <span>RAM</span>
              <span>DISCO</span>
              <span>BATERIA</span>
            </div>
            <div class="lista-maquinas">
              <div class="msg_nenhum_dado">
                <p>Nenhum dado encontrado!</p>
              </div>
            </div>
          </div>
          <!-- <div class="card">
                                <p>Máquinas com vida útil abaixo do recomendado:</p>
                                <span>5</span>
                                <p>Recomendado: 40%</p>
                            </div> -->
        </div>
        <div class="graficos">
          <div class="card-grafico" id="card_grafico">
            <div id="chart" style="width: 400px; height: 250px"></div>
          </div>
          <div class="card-grafico" id="grafico_media">
            <div id="chart_div"></div>
          </div>
        </div>
        <!-- <div class="graficos"></div> -->
      </div>

      <!-- modal de visão geral-->
      <div id="modal1" class="modal">
        <div class="modal-content">
          <span class="fechar-modal" onclick="closeModal('modal1')">&times;</span>
          <div class="titulo">
            <h2>Lista de Máquinas Ligadas: </h2>
            <p id="qtd_maquinas"></p>
          </div>
          <ul id="lista_maquinas_ligadas"> </ul>
        </div>
      </div>

      <div id="modal2" class="modal">
        <div class="modal-content">
          <span class="fechar-modal" onclick="closeModal('modal2')">&times;</span>
          <div class="titulo">
            <h2>Lista de Máquinas em Risco: </h2>
            <p id="qtd_maquinas_risco"></p>
          </div>
          <ul id="lista_maquinas_risco">

        </div>
      </div>

      <div id="modal3" class="modal">
        <div class="modal-content">
          <span class="fechar-modal" onclick="closeModal('modal3')">&times;</span>
          <div class="titulo">
            <h2>Lista de Máquinas com pouca bateria: </h2>
            <p id="qtd_maquinas_bateria"></p>
          </div>
          <ul id="lista_maquinas_bateria">
          </ul>
        </div>
      </div>


    </section>
  </div>
</body>

</html>

<script src="dashboardGrafico.js"></script>

<script>
  let saudacoes = document.getElementById("saudacoes");
  let botaoUsuario = document.querySelector('.criarUsuarioNavegador');
  let nivelAcesso = sessionStorage.NIVEL_ACESSO;

  if (nivelAcesso != "Alto") {
    botaoUsuario.style.display = 'none';
  }

  saudacoes.innerHTML = `Bem-Vindo(a) de volta ${sessionStorage.USER_NAME}`;

</script>

<script>
  let qtd_Maquinas_Total = 0;

  function mensagemDadosNaoEncontrados(nomeElemento) {
    nomeElemento.innerHTML = `<div>
    <p>Nenhum dado encontrado!</p>
  </div>`;
  }

  function calcularPorcent(listaSeparada) {
    const totalSeparada = listaSeparada.length;
    let porcentagem = 0;

    if (qtd_Maquinas_Total === 0) {
      porcentagem = 0;
    } else {
      porcentagem = (totalSeparada / qtd_Maquinas_Total) * 100;
    }

    return porcentagem;
  }

  function visaoGeral() {
    const qtd_maquinas_ligadas = document.getElementById("maquinas_ligadas");
    const lista_maquinas_ligadas = document.getElementById("lista_maquinas_ligadas");
    const qtd_maquinas = document.getElementById("qtd_maquinas");
    const barra_status = document.getElementById("barra-status");

    let data = [];


    //Máquinas ligadas
    fetch(`/maquina/buscar/${sessionStorage.ID_INSTITUICAO}`).then(resposta => {
      if (!resposta.ok) {
        throw new Error(`Erro na solicitação fetch: ${resposta.status} ${resposta.statusText}`);
      }
      return resposta.json();
    }).then(json => {

      console.log("Dados recebidos: ", json);
      qtd_Maquinas_Total += json.length;

      json.forEach(item => {
        if (item.status === 0) {
          data.push(item);
          lista_maquinas_ligadas.innerHTML += `<li>Máquina: ${item.nome}</li>`;
        }
      });

      if (data.length <= 0) {
        lista_maquinas_bateria.innerHTML += `<p>Sem máquinas para mostrar</p>`; //ARRUMAR FRONT DISSO
      }

      const porcet = calcularPorcent(data);

      if (porcet <= 20) {
        barra_status.style.backgroundColor = "red";
        qtd_maquinas.style.backgroundColor = "red";
      } else if (porcet <= 50) {
        barra_status.style.backgroundColor = "yellow";
        qtd_maquinas.style.backgroundColor = "yellow";
      } else {
        barra_status.style.backgroundColor = "green";
        qtd_maquinas.style.backgroundColor = "green";
      }

      qtd_maquinas_ligadas.innerHTML = data.length;

      qtd_maquinas.innerHTML = `${data.length}/${json.length} cadastradas`;

    }).catch(error => {
      console.error("Error ao buscar dados:", error);

    });

    //Máquina e Bateria
    const maquinas_pouca_bateria = document.getElementById("maquinas_pouca_bateria");
    const lista_maquinas_bateria = document.getElementById("lista_maquinas_bateria");
    const qtd_maquinas_bateria = document.getElementById("qtd_maquinas_bateria");
    const barra_status_bateria = document.getElementById("barra_status_bateria");

    fetch(`/maquina/infoBateria/${sessionStorage.ID_INSTITUICAO}`).then(resposta => {
      if (!resposta.ok) {
        throw new Error(`Erro na solicitação fetch: ${resposta.status} ${resposta.statusText}`);
      }
      return resposta.json();
    }).then(json => {

      console.log("Dados recebidos: ", json);

      let mq_pouca_bateria = [];

      json.forEach(item => {
        const itemJaExiste = mq_pouca_bateria.some(e => e.idProcessador === item.idProcessador);

        if (item.porcentagemBateria <= 30 && !itemJaExiste) {
          mq_pouca_bateria.push(item);
          lista_maquinas_bateria.innerHTML += `<li>Máquina: ${item.nome}</li>`;
        }

      });

      const porcet = calcularPorcent(mq_pouca_bateria);
      
      if (porcet <= 20) {
        barra_status_bateria.style.backgroundColor = "green";
        qtd_maquinas_bateria.style.backgroundColor = "green";
      } else if (porcet <= 50) {
        barra_status_bateria.style.backgroundColor = "yellow";
        qtd_maquinas_bateria.style.backgroundColor = "yellow";
      } else {
        barra_status_bateria.style.backgroundColor = "red";
        qtd_maquinas_bateria.style.backgroundColor = "red";
      }
      
      if (mq_pouca_bateria.length <= 0) {
        lista_maquinas_bateria.innerHTML += `<p>Sem máquinas para mostrar</p>`;
      }

      maquinas_pouca_bateria.innerHTML = mq_pouca_bateria.length;

      qtd_maquinas_bateria.innerHTML = `${mq_pouca_bateria.length}/${qtd_Maquinas_Total} cadastradas`;
      

    }).catch(error => {
      console.error("Error ao buscar dados:", error);
    });
  }

  function statusComponentes() {
    const lista_maquinas = document.querySelector(".lista-maquinas");

    fetch(`/maquina/porcentagem/${sessionStorage.ID_INSTITUICAO}`).then(resposta => {
      if (!resposta.ok) {
        throw new Error(`Erro na solicitação fetch: ${resposta.status} ${resposta.statusText}`);
      }
      return resposta.json();
    }).then(json => {
      console.log("Dados recebidos: ", json);

      let components = json;
      console.log('COMPONENTES RECIBIDOS POR JSON: ', components);

      // Verifica se o JSON está vazio
      if (components.length === 0) {
        const div = document.createElement("div");
        div.innerHTML = `<p>Nenhum dado encontrado!</p>`;
        lista_maquinas.appendChild(div);
        return;
      }

      components.forEach(item => {
        let bom = 0;
        let alerta = 0;
        let critico = 0;

        if (item.CPU >= 90) {
          critico++;
        } else if (item.CPU >= 80) {
          alerta++;
        } else if (item.CPU == null) {
          critico++;
        } else {
          bom++;
        }

        if (item.RAM >= 80) {
          critico++
        } else if (item.RAM >= 70) {
          alerta++;
        } else if (item.RAM == null) {
          critico++;
        } else {
          bom++;
        }

        if (item.DISCO >= 80) {
          critico++
        } else if (item.DISCO >= 70) {
          alerta++;
        } else if (item.DISCO == null) {
          critico++;
        } else {
          bom++;
        }

        if (item.BATERIA <= 15) {
          critico++;
        } else if (item.BATERIA <= 60) {
          alerta++;
        } else if (item.BATERIA == null) {
          critico++;
        } else {
          bom++;
        }

        let status;

        if (bom >= alerta && bom >= critico) {
          status = "Bom";
        } else if (alerta >= bom && alerta >= critico) {
          status = "Alerta";
        } else {
          status = "Critico"
        }

        if (critico >= 2 || critico == 4) {
          status = "Critico"
        } else if (bom == 4) {
          status = "Bom"
        } else {
          status = "Alerta"
        }

        item.STATUS = status

        console.log(item)
      });

      const order = [];
      let maquinasCriticas = [];

      function verificaEOrdenaPorStatusItem() {

        for (let i = 0; i < components.length; i++) {
          let corStatus;
          const status = components[i].STATUS;

          switch (status) {
            case "Critico":
              corStatus = "red";
              order.splice(i, 0, { ...components[i], corStatus });
              maquinasCriticas.push(components[i]);
              break;
            case "Alerta":
              corStatus = "yellow";
              order.splice(i, 0, { ...components[i], corStatus });
              break;
            case "Bom":
              corStatus = "green";
              order.splice(i, 0, { ...components[i], corStatus });
              break;
            default:
              corStatus = "none";
          }
        }
      }

      function createItem(item) {
        const div = document.createElement("div");
        div.classList.add("item-maquina");

        console.log('ITEM BATERIA', item.BATERIA);

        div.innerHTML = `
            <span>${item.nome}</span>
            <span>${item.CPU == null ? "-" : (item.CPU).toFixed(1)}%</span>
            <span>${item.RAM == null ? "-" : (item.RAM).toFixed(1)}%</span>
            <span>${item.DISCO == null ? "-" : (item.DISCO).toFixed(1)}%</span>
            <span>${item.BATERIA == null ? "-" : item.BATERIA}%</span>
        `;
        div.style.borderBottom = `6px solid ${item.corStatus}`;
        lista_maquinas.appendChild(div);
      }

      function updateList() {
        lista_maquinas.innerHTML = "";
        order.forEach(createItem);
      }

      function updateMaquinasRisco() {
        const maquinas_risco = document.getElementById("maquinas_risco");
        const barra_status_risco = document.getElementById("barra_status_risco");
        const qtd_maquinas_risco = document.getElementById("qtd_maquinas_risco");
        const lista_maquinas_risco = document.getElementById("lista_maquinas_risco");

        const porcet = calcularPorcent(maquinasCriticas);

        console.log("porcentagem ", porcet)

        if (porcet >= 80) {
          barra_status_risco.style.backgroundColor = "red";
          qtd_maquinas_risco.style.backgroundColor = "red";
        } else if (porcet >= 50) {
          barra_status_risco.style.backgroundColor = "yellow";
          qtd_maquinas_risco.style.backgroundColor = "yellow";
        } else {
          barra_status_risco.style.backgroundColor = "green";
          qtd_maquinas_risco.style.backgroundColor = "green";
        }

        maquinasCriticas.forEach(item => {
          lista_maquinas_risco.innerHTML += `<li>Máquina: ${item.nome}</li>`;
        })

        if (lista_maquinas_risco.length <= 0) {
          lista_maquinas_risco.innerHTML += `<p>Sem máquinas para mostrar</p>`; //ARRUMAR FRONT DISSO
        }

        maquinas_risco.innerHTML = maquinasCriticas.length;
        qtd_maquinas_risco.innerHTML = `${maquinasCriticas.length}/${components.length} cadastradas`;

      }

      verificaEOrdenaPorStatusItem();
      updateList();
      updateMaquinasRisco();
    });

    setTimeout(statusComponentes, 5000);
  }



  //   modal
  function openModal(modalId) {
    // Ocultar todos os modais
    var modais = document.querySelectorAll('.modal');
    modais.forEach(function (modal) {
      modal.style.display = 'none';
    });

    // Exibir o modal correspondente
    var modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'block';
    }
  }

  // Função para fechar todos os modais
  function closeModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  }


</script>