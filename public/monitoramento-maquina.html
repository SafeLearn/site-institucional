<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/monitoramento-maquina.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="sweetalert2.min.css">
    <link rel="shortcut icon" href="./imagens/logoSafePrint.png">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>SafeLearn -- Dashboard</title>
</head>

<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="#" class="logo">
                        <img src="./imagens/logoSafePrint.png" alt="Logo SafePrint">
                        <span class="nav-item">DashBoard</span>
                    </a></li>
                <li><a href="./dashboard.html">
                        <i class="fas fa-home"></i>
                        <span class="nav-item">Home</span>
                    </a></li>
                <li class="criarUsuarioNavegador"><a href="./criaruser.html">
                        <i class="fas fa-user"></i>
                        <span class="nav-item">Usuários</span>
                    </a></li>
                <li><a href="./monitorar.html" id="active">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-item">Monitoramento</span>
                    </a></li>
                <li><a href="./suporte.html">
                        <i class="fas fa-question-circle"></i>
                        <span class="nav-item">Suporte</span>
                    </a></li>
                <li id="ativador">
                    <i class="fas fa-power-off"></i>
                    <span class="nav-item">Desligar Máquina</span>
                    <div class="listaOpcoes">
                        <span onclick="desligar(1)">Desligar</span>
                        <span onclick="desligar(2)">Reiniciar</span>
                        <span onclick="desligar(3)">Suspender</span>
                    </div>
                </li>
                <li><a href="./home.html" class="logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="nav-item">Sair</span>
                    </a></li>
            </ul>
        </nav>

        <section class="main">
            <div class="main-top">
                <img src="./imagens/icons-dash/arrow-left-svgrepo-com.svg" alt="Seta" id="seta_main">
                <h1>Visualização da Máquina - 0221</h1>
                <i class="fas fa-user-cog"></i>
            </div>

            <div class="graficos-wrapper">
                <div class="graficos-container" id="graficos_container">
                    <div id="graficoCPU" class="grafico1"></div>
                    <div id="graficoDISCO"></div>
                    <div id="grafico4" class="grafico4">
                        <h1>Informações da máquina:</h1>
                        <div class="lista-info">
                            <span><img src="imagens/icons-dash/clock-five.svg">Tempo de atividade: <p>2 horas e 35 minutos</p></span>
                            <span><img src="imagens/icons-dash/battery-full.svg">Porcentagem da bateria: <p>100%</p></span>
                            <span><img src="imagens/icons-dash/charging-station.svg">Status: <p>Conectado a energia</p></span>
                            <span><img src="imagens/icons-dash/it.svg">Vida útil da bateria: <p>80%</p></span>
                        </div>
                    </div>
                </div>
                <div class="graficos-container">
                    <div id="graficoRAM" class="grafico3"></div>
                    <div class="janela-container">
                        <div class="janelas">
                            <h4><i class="fa-solid fa-computer"></i>Janelas em aberto</h4>
                            <ul>
                                <li>Título: Google Chrome</li>
                                <li>Título: Microsoft Word</li>
                                <li>Título: Microsoft Excel</li>
                                <li>Título: Photoshop</li>
                                <li>Título: Microsoft Powerpoint</li>
                                <li>Título: Visual Studio Code</li>
                                <!-- Additional windows can be listed here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let botaoDesligar = document.querySelector('#ativador');
        let botaoUsuario = document.querySelector('.criarUsuarioNavegador');
        let nivelAcesso = sessionStorage.NIVEL_ACESSO;

        if (nivelAcesso == "Baixo") {
            botaoDesligar.style.display = 'none';
            botaoUsuario.style.display = 'none';
        } else if (nivelAcesso == "Médio") {
            botaoUsuario.style.display = 'none';
        }

        const listaOpcoes = document.querySelector('.listaOpcoes');
        const ativador = document.querySelector('#ativador');

        function toggleListaOpcoes() {
            const isActive = ativador.classList.contains('active');
            ativador.classList.toggle('active');
            listaOpcoes.style.display = isActive ? 'none' : 'flex';
        }

        ativador.addEventListener('click', toggleListaOpcoes);

        function desligar(chamada) {
            let title, title2, text2;

            if (chamada == 1) {
                title = "Tem certeza que deseja desligar a máquina 0221?";
                title2 = "Desligando...";
                text2 = "A máquina está sendo desligada!";
            } else if (chamada == 2) {
                title = "Tem certeza que deseja reiniciar a máquina 0221?";
                title2 = "Reiniciando...";
                text2 = "A máquina está sendo reiniciada!";
            } else if (chamada == 3) {
                title = "Tem certeza que deseja suspender a máquina 0221?";
                title2 = "Suspendendo...";
                text2 = "A máquina está sendo suspendida!";
            }

            Swal.fire({
                title: title,
                icon: "warning",
                backdrop: `rgba(0,0,0,0.4)`,
                showCancelButton: true,
                confirmButtonText: "Sim, tenho certeza!",
                cancelButtonText: "Não, cancela!",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: title2,
                        text: text2,
                        icon: "success"
                    });
                    desligarMaquina(2);
                }
            });
        }

        function desligarMaquina(idMaquina) {
            console.log("DESLIGANDO A MAQUINA: " + idMaquina);
        }

        let proximaAtualizacaoCPU;
        let proximaAtualizacaoRAM;
        let proximaAtualizacaoDISCO;

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (id) {
                obterDadosDeCPU(id);
                obterDadosDeRAM(id);
            } else {
                console.log("ID não encontrado na URL");
            }
        };

        function dadosNaoEncontrados(nomeElemento) {
            nomeElemento.innerHTML = `<div><p>Nenhum dado encontrado!</p></div>`;
        }

        function exibirGraficos(idProcessador, especificacao, nomeComponente) {
            const grafico = document.getElementById(`grafico${nomeComponente}`);

            if (nomeComponente === 'CPU') {
                grafico.innerHTML = `
                    <span class="titulo">Uso de CPU<p>Total de frequência: ${especificacao} GHz</p></span>
                    <canvas id="grafico${idProcessador}Canvas" style="height: 220px;"></canvas>`;
            } else if (nomeComponente === 'RAM') {
                grafico.innerHTML = `
                    <span class="titulo">Uso de Memória RAM<p>Memória total: ${especificacao} GB</p></span>
                    <canvas id="grafico${idProcessador}Canvas" style="height: 220px;"></canvas>`;
            } else {
                grafico.innerHTML = `
                    <span class="titulo">Uso de Disco</span>
                    <div id="piechart_3d" style="height: 200px; width: 200px; margin: 0 auto"></div>`;
            }
        }

        function atualizarGrafico(idProcessador, registros, nomeComponente) {
            const labels = registros.reverse().map(registro => {
                const data = new Date(registro.momento);
                return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            });

            console.log(registros)
            const dados = registros.map(registro => {
                if (nomeComponente === 'DISCO') {
                    return Math.floor((registro.valorCaptura / 1000000000) * 100);
                } else {
                    console.log(registro.valorCaptura)
                    return registro.valorCaptura;
                }
            });

            console.log(dados)

            if (nomeComponente === 'DISCO') {
                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Espaço');
                data.addColumn('number', 'Quantidade');
                data.addRows([
                    ['Usado', dados[0]],
                    ['Disponível', 100 - dados[0]],
                ]);

                const options = {
                    title: 'Uso do Disco',
                    is3D: true,
                };

                const chart = new google.visualization.PieChart(document.getElementById('piechart_3d'));
                chart.draw(data, options);
            } else {
                const ctx = document.getElementById(`grafico${idProcessador}Canvas`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Uso de CPU',
                            data: dados,
                            backgroundColor: nomeComponente === 'CPU' ? 'rgba(255, 99, 132, 0.2)' : 'rgba(54, 162, 235, 0.2)',
                            borderColor: nomeComponente === 'CPU' ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                        }],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });
            }
        }

        function obterDadosDeCPU(id) {
            fetch(`/maquina/usoDeComponente/${id}/CPU`, { cache: "no-store" })
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            if (dados.length > 0) {
                                dados.forEach(componente => {
                                    const idProcessador = id;
                                    const especificacao = componente.especificacaoComponente;
                                    exibirGraficos(idProcessador, especificacao, 'CPU');
                                    obterRegistrosCPU(idProcessador);
                                });
                            } else {
                                dadosNaoEncontrados(document.getElementById('graficoCPU'));
                            }
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                        dadosNaoEncontrados(document.getElementById('graficoCPU'));
                    }
                })
                .catch(erro => {
                    console.error('Erro na requisição:', erro);
                });
        }

        function obterRegistrosCPU(idProcessador) {
            fetch(`/maquina/tempo-real/${idProcessador}/CPU`, { cache: "no-store" })
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(registros => {
                            atualizarGrafico(idProcessador, registros, 'CPU');
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                    }
                })
                .catch(console.error);
            clearTimeout(proximaAtualizacaoCPU);
            proximaAtualizacaoCPU = setTimeout(() => obterRegistrosCPU(idProcessador), 5000);
        }

        function obterDadosDeRAM(id) {
            fetch(`/maquina/tempo-real/${id}/RAM`, { cache: "no-store" })
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(resposta => {
                            if (resposta.length > 0) {
                                resposta.forEach(componente => {
                                    const especificacao = componente.especificacaoComponente;
                                    exibirGraficos(id, especificacao, 'RAM');
                                    obterRegistrosRAM(id);
                                });
                            } else {
                                dadosNaoEncontrados(document.getElementById('graficoRAM'));
                            }
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                        dadosNaoEncontrados(document.getElementById('graficoRAM'));
                    }
                })
                .catch(console.error);
        }

        function obterRegistrosRAM(id) {
            fetch(`/maquina/usoDeComponente/${id}/RAM`, { cache: "no-store" })
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(registros => {
                            atualizarGrafico(id, registros, 'RAM');
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                    }
                })
                .catch(console.error);
            clearTimeout(proximaAtualizacaoRAM);
            proximaAtualizacaoRAM = setTimeout(() => obterRegistrosRAM(id), 5000);
        }

        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(obterDadosDeDisco);

        function obterDadosDeDisco() {
            const registros = [
                { espacoUso: 50, dataHora: new Date() },
                // Aqui você deve buscar e adicionar os registros reais
            ];
            atualizarGrafico(null, registros, 'DISCO');
            clearTimeout(proximaAtualizacaoDISCO);
            proximaAtualizacaoDISCO = setTimeout(obterDadosDeDisco, 5000);
        }
    </script>
</body>

</html>
